<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAU_Vahan ‚Äì Driver Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    .toast { position: fixed; top: 20px; right: 20px; background: #16a34a; color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,.2); display:none; z-index: 60; }
    .dark body { background: #111827; color: #f9fafb; }
    .dark .bg-white { background: #1f2937 !important; color: #f9fafb; }
    .badge { border: 1px dashed rgba(0,0,0,.15); padding: 6px 10px; border-radius: 10px; }
    .modal-mask{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:70;}
    .modal{ background:white; border-radius:16px; padding:16px; width:90%; max-width:400px; }
    .dark .modal{ background:#1f2937; color:#f9fafb; }
  </style>
</head>
<body class="bg-gray-100 font-sans transition-colors">
  <!-- Layout -->
  <div class="flex h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-green-900 text-white flex flex-col p-6 space-y-6 shadow-xl">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold flex items-center space-x-2">
          <i data-lucide="car-front"></i><span>SAU_Vahan</span>
        </h1>
        <button id="darkModeToggle" class="p-2 rounded hover:bg-green-800" title="Toggle theme">
          <i data-lucide="moon"></i>
        </button>
      </div>
      <nav class="flex flex-col space-y-3">
        <button class="flex items-center space-x-2 hover:bg-green-700 px-3 py-2 rounded transition bg-green-700">
          <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
        </button>
        <button class="flex items-center space-x-2 hover:bg-green-700 px-3 py-2 rounded transition">
          <i data-lucide="map"></i><span>Live Map</span>
        </button>
        <button class="flex items-center space-x-2 hover:bg-green-700 px-3 py-2 rounded transition">
          <i data-lucide="history"></i><span>Trip History</span>
        </button>
        <button class="flex items-center space-x-2 hover:bg-green-700 px-3 py-2 rounded transition">
          <i data-lucide="log-out"></i><span>Logout</span>
        </button>
      </nav>
      <div class="mt-auto">
        <h4 class="text-sm uppercase tracking-wide text-green-200 mb-2">Notifications</h4>
        <div id="notifPanel" class="space-y-2 max-h-40 overflow-auto pr-1">
          <p class="text-green-100/80 text-sm">No notifications yet</p>
        </div>
      </div>
    </aside>

    <!-- Main Dashboard -->
    <main class="flex-1 p-6 space-y-6 overflow-y-auto">

      <!-- Driver Card -->
      <section class="bg-white p-6 rounded-xl shadow flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <label for="avatarUpload" class="cursor-pointer">
            <img id="driverAvatar" src="https://via.placeholder.com/60" class="w-16 h-16 rounded-full border-2 border-green-600 object-cover" />
            <input type="file" id="avatarUpload" class="hidden" accept="image/*">
          </label>
          <div>
            <h2 class="text-xl font-bold" id="driverNameDisplay">Driver</h2>
            <p class="text-sm text-gray-500" id="welcomeMessage">Hi üëã, welcome!</p>
            <p id="statusDisplay" class="text-gray-500 flex items-center space-x-2">
              <span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span>
              <span>Not logged in</span>
            </p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <input id="driverName" type="text" placeholder="Enter name" class="border p-2 rounded">
          <button id="loginBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Login</button>
        </div>
      </section>

      <!-- Quote + Badges -->
      <section class="grid grid-cols-1 md-grid-cols-2 md:grid-cols-2 gap-4">
        <div class="bg-white p-4 rounded-xl shadow text-center">
          <p class="text-gray-500">Quote of the Day</p>
          <h3 id="quote" class="text-lg font-semibold">üö¶ Safe driving keeps you & students safe</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow text-center">
          <p class="text-gray-500">Achievements</p>
          <div class="flex items-center justify-center gap-2 flex-wrap" id="badges">
            <span class="badge">‚≠ê 0 rides</span>
          </div>
        </div>
      </section>

      <!-- Status Buttons -->
      <div id="statusButtons" class="hidden flex space-x-3">
        <button id="availableBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center space-x-1">
          <i data-lucide="check"></i><span>Available</span>
        </button>
        <button id="breakBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded flex items-center space-x-1">
          <i data-lucide="coffee"></i><span>Break</span>
        </button>
        <button id="offlineBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded flex items-center space-x-1">
          <i data-lucide="power"></i><span>Offline</span>
        </button>
      </div>

      <!-- Work Times section -->
      <section class="bg-white p-4 rounded-xl shadow" id="workTimesSection">
        <h2 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="timer"></i> <span>Work Time</span></h2>
        <ul id="workTimesList" class="text-gray-700 text-sm"></ul>
      </section>

      <!-- Dashboard Cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white p-4 rounded-xl shadow">
          <p class="text-gray-500">Total Trips</p>
          <h3 id="totalTrips" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow">
          <p class="text-gray-500">Active Rides</p>
          <h3 id="activeRides" class="text-2xl font-bold">0</h3>
        </div>
        <div class="bg-white p-4 rounded-xl shadow">
          <p class="text-gray-500">Status</p>
          <h3 id="statusCard" class="text-2xl font-bold">Offline</h3>
        </div>
      </section>

      <!-- Seats Management -->
      <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold flex items-center space-x-2 mb-4">
          <i data-lucide="users"></i><span>Seats Management</span>
        </h2>
        <div class="flex items-center space-x-3">
          <button id="seatMinus" class="bg-red-500 text-white px-3 py-1 rounded">-</button>
          <p id="seatCount" class="text-lg font-bold">4</p>
          <button id="seatPlus" class="bg-green-500 text-white px-3 py-1 rounded">+</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Max 5 students can be accepted in one ride.</p>
      </section>

      <!-- Mini Map Widget -->
      <section class="bg-white p-4 rounded-xl shadow">
        <h2 class="text-lg font-semibold flex items-center space-x-2 mb-2"><i data-lucide="map-pin"></i><span>Mini Map</span></h2>
        <div id="miniMap" class="w-full h-48 rounded-xl"></div>
      </section>

      <!-- Live Map -->
      <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold flex items-center space-x-2 mb-4">
          <i data-lucide="map"></i><span>Live Location</span>
        </h2>
        <div id="map" class="w-full h-72 rounded-xl"></div>
      </section>

      <!-- Ride Requests -->
      <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold flex items-center space-x-2 mb-4">
          <i data-lucide="bell-ring"></i><span>Incoming Ride Requests</span>
        </h2>
        <div id="requests" class="space-y-3"></div>
      </section>

      <!-- Ride Progress -->
      <section class="bg-white p-6 rounded-xl shadow hidden" id="rideProgressSection">
        <h2 class="text-lg font-semibold mb-2">Ride Progress</h2>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="rideProgressBar" class="bg-green-600 h-4 rounded-full w-0"></div>
        </div>
      </section>

      <!-- Trip History -->
      <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-xl font-semibold flex items-center space-x-2 mb-1">
          <i data-lucide="history"></i><span>Trip History</span>
        </h2>
        <div id="routeStats" class="text-xs text-gray-500 mb-3"></div>
        <div class="flex space-x-3 mb-4">
          <button class="filterBtn bg-green-600 text-white px-3 py-1 rounded" data-filter="today">Today</button>
          <button class="filterBtn bg-gray-200 px-3 py-1 rounded" data-filter="week">This Week</button>
          <button class="filterBtn bg-gray-200 px-3 py-1 rounded" data-filter="all">All Time</button>
        </div>
        <div id="historyList" class="space-y-3"></div>
      </section>

      <!-- End Trip Floating Button -->
      <div class="fixed bottom-6 right-6 z-50">
        <button id="endTripBtn" class="hidden bg-red-600 hover:bg-red-700 text-white px-5 py-3 rounded-full shadow-lg flex items-center space-x-2">
          <i data-lucide="flag"></i><span>End Trip</span>
        </button>
      </div>

    </main>
  </div>

  <div id="toast" class="toast">New Ride Request üöñ</div>

  <!-- Offline reason modal (unchanged, already present) -->
  <div id="offlineModal" class="modal-mask">
    <div class="modal">
      <h3 class="text-lg font-semibold mb-2 flex items-center gap-2"><i data-lucide="alert-octagon"></i> Go Offline</h3>
      <p class="text-sm mb-3">Select a reason:</p>
      <div class="space-y-2">
        <label class="flex items-center gap-2"><input type="radio" name="offreason" value="Service over" class="reasonOpt"> <span>Service over</span></label>
        <label class="flex items-center gap-2"><input type="radio" name="offreason" value="Lunch" class="reasonOpt"> <span>Lunch</span></label>
        <label class="flex items-center gap-2"><input type="radio" name="offreason" value="Other" class="reasonOpt"> <span>Other</span></label>
        <input id="otherReason" type="text" placeholder="Write reason..." class="w-full border rounded p-2 hidden">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelOffline" class="px-3 py-1 rounded border">Cancel</button>
        <button id="confirmOffline" class="px-3 py-1 rounded bg-gray-700 text-white">Go Offline</button>
      </div>
    </div>
  </div>

  <!-- Firebase + JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onChildAdded, onValue, update, set, push } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDy8XPh_hvFVLEWhWI1i---1q02vrdhGzA",
      authDomain: "sau-vahan.firebaseapp.com",
      databaseURL: "https://sau-vahan-default-rtdb.firebaseio.com",
      projectId: "sau-vahan",
      storageBucket: "sau-vahan.firebasestorage.app",
      messagingSenderId: "130144606109",
      appId: "1:130144606109:web:31a03191d481e3bc7c4174"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === Landmarks for route stats (adjust coords if needed) ===
    const SAU1 = { lat: 28.7041, lng: 77.1025 };      // placeholder for SAU-1
    const SATBARI = { lat: 28.4816, lng: 77.1873 };   // approx Satbari, Delhi
    const NEAR_RADIUS_KM = 1.5;

    // THEME: auto-detect + remember
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const savedTheme = localStorage.getItem('theme');
    if ((savedTheme === 'dark') || (!savedTheme && prefersDark)) {
      document.documentElement.classList.add('dark');
    }
    document.getElementById('darkModeToggle').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    let driver=null, driverRef=null, totalTrips=0;
    let activeRideKeys = [];
    let map, marker, miniMap, miniMarker;
    let seatCount = 4;         // UI-controlled, hard-capped at 5
    const MAX_SEATS = 5;
    const historyData = [];
    let rideBatchInProgress = false;

    // Track work times
    let workTimes = [];                   // Array of {start, end}
    let sessionStart = null;

    // Per-ride ETA DOM spans to update with GPS
    const etaSpans = new Map(); // rideKey -> {distEl, etaEl}

    // Daily route counters
    let dailyRouteCounts = {
      SAU1_to_SATBARI: 0,
      SATBARI_to_SAU1: 0
    };

    // Avatar upload (local preview)
    document.getElementById('avatarUpload').addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(file){
        const reader=new FileReader();
        reader.onload=()=>{ document.getElementById('driverAvatar').src=reader.result; };
        reader.readAsDataURL(file);
      }
    });

    // Toast + Notification Panel
    function pushNotif(text){
      const panel=document.getElementById('notifPanel');
      if(panel.firstElementChild && panel.firstElementChild.tagName === 'P') panel.innerHTML = '';
      const row=document.createElement('div');
      row.className='text-sm bg-green-800/30 border border-green-700/30 rounded px-2 py-1';
      row.textContent = text;
      panel.prepend(row);
    }
    function showToast(msg="New Ride Request üöñ"){
      const toast=document.getElementById('toast');
      toast.innerText = msg;
      toast.style.display='block';
      try { new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); } catch(e){}
      setTimeout(()=>toast.style.display='none',3000);
      pushNotif(msg);
    }

    // Login
    document.getElementById('loginBtn').addEventListener('click', () => {
      const name = document.getElementById('driverName').value.trim();
      if (!name) return alert('Enter name');
      driver = { name, status: 'available' };
      driverRef = ref(db, 'drivers/' + name);

      set(driverRef, {
        name,
        status: 'available',
        status_reason: '',
        seats: seatCount,
        lat: 0,
        lng: 0,
        timestamp: Date.now(),
        trips: 0,
        activeRide: null
      });

      // Start work session
      sessionStart = Date.now();
      workTimes.push({start: sessionStart, end: null});
      renderWorkTimes();

      document.getElementById('driverNameDisplay').innerText = name;
      document.getElementById('welcomeMessage').innerText = `Hi ${name} üëã, ready to ride?`;
      setStatusBadge('available', '');
      document.getElementById('statusButtons').classList.remove('hidden');
      document.getElementById('statusCard').innerText = 'Available';

      startLocationTracking();
      showToast(`Welcome ${name}! You are now available.`);
    });

    function setStatusBadge(state, reason=''){
      let color = 'bg-green-500', label = '‚úÖ Available';
      if (state === 'break') { color = 'bg-yellow-500'; label = '‚òï On Break'; }
      if (state === 'offline') { color = 'bg-gray-500'; label = `‚õî Offline${reason ? ' ‚Äì ' + reason : ''}`; }
      document.getElementById('statusDisplay').innerHTML =
        `<span class="w-2 h-2 rounded-full ${color} inline-block"></span> ${label}`;
      document.getElementById('statusCard').innerText = state === 'available' ? 'Available' : (state === 'break' ? 'On Break' : 'Offline');
    }

    // Status Updates
    document.getElementById('availableBtn').addEventListener('click', () => {
      if (!driver) return;
      driver.status = 'available';
      update(driverRef, { status: 'available', status_reason: '' });

      // If coming online from offline, start new session
      if (!sessionStart) {
        sessionStart = Date.now();
        workTimes.push({start: sessionStart, end: null});
        renderWorkTimes();
      }

      setStatusBadge('available', '');
      showToast('You are now Available');
    });

    document.getElementById('breakBtn').addEventListener('click', () => {
      if (!driver) return;
      driver.status = 'break';
      update(driverRef, { status: 'break', status_reason: '' });
      setStatusBadge('break', '');
      showToast('You are on Break');
    });

    // Offline flow with reason
    const offlineBtn = document.getElementById('offlineBtn');
    const offlineModal = document.getElementById('offlineModal');
    const otherReasonInput = document.getElementById('otherReason');
    offlineBtn.addEventListener('click', ()=>{
      if (!driver) return showToast('Login first');
      offlineModal.style.display='flex';
    });
    offlineModal.addEventListener('click', (e)=>{
      if (e.target === offlineModal) offlineModal.style.display='none';
    });
    document.querySelectorAll('.reasonOpt').forEach(r=>{
      r.addEventListener('change', ()=>{
        otherReasonInput.classList.toggle('hidden', r.value !== 'Other' || !r.checked);
      });
    });
    document.getElementById('cancelOffline').addEventListener('click', ()=>{
      offlineModal.style.display='none';
    });
    document.getElementById('confirmOffline').addEventListener('click', ()=>{
      const selected = [...document.querySelectorAll('.reasonOpt')].find(x=>x.checked);
      let reason = selected ? selected.value : '';
      if (reason === 'Other') reason = otherReasonInput.value.trim();
      if (!reason) { alert('Please select or write a reason'); return; }
      driver.status = 'offline';

      update(driverRef, { status: 'offline', status_reason: reason });
      setStatusBadge('offline', reason);
      offlineModal.style.display='none';
      showToast('You are Offline');

      // End current work session if any
      if (sessionStart && (!workTimes[workTimes.length-1].end)) {
        workTimes[workTimes.length-1].end = Date.now();
        sessionStart = null;
        renderWorkTimes();
      }
    });

    // Work times rendering
    function renderWorkTimes() {
      const ul = document.getElementById('workTimesList');
      ul.innerHTML = '';
      if (!workTimes.length) {
        ul.innerHTML = '<li>No shifts yet</li>';
        return;
      }
      workTimes.forEach(w=>{
        let start = new Date(w.start).toLocaleTimeString();
        let end = w.end ? new Date(w.end).toLocaleTimeString() : "<span class='text-emerald-600 font-semibold'>in progress‚Ä¶</span>";
        let duration = w.end ? (Math.round((w.end-w.start)/60000) + " min") : '';
        ul.innerHTML += `<li>üïí ${start} ‚Äì ${end} ${duration ? ("(<b>" + duration +"</b>)") : ""}</li>`;
      });
    }

    // Seats management (capped at 5)
    const seatDisplay = document.getElementById('seatCount');
    function syncSeatToFirebase(){ if (driverRef) update(driverRef, { seats: seatCount }); }
    document.getElementById('seatPlus').addEventListener('click', () => {
      if (seatCount < MAX_SEATS) {
        seatCount++;
        seatDisplay.innerText = seatCount;
        syncSeatToFirebase();
      } else {
        showToast('Seat limit is 5');
      }
    });
    document.getElementById('seatMinus').addEventListener('click', () => {
      if (seatCount>0) {
        seatCount--;
        seatDisplay.innerText = seatCount;
        syncSeatToFirebase();
      }
    });

    // Ride Progress
    const rideProgressSection = document.getElementById('rideProgressSection');
    const rideProgressBar = document.getElementById('rideProgressBar');
    const endTripBtn = document.getElementById('endTripBtn');
    let progressInterval = null;

    function startProgress(){
      rideProgressSection.classList.remove('hidden');
      endTripBtn.classList.remove('hidden');
      let width=0;
      clearInterval(progressInterval);
      progressInterval=setInterval(()=>{
        if(width>=100){ clearInterval(progressInterval); }
        else { width+=10; rideProgressBar.style.width=width+'%'; }
      }, 1000);
    }
    function resetProgress(){
      clearInterval(progressInterval);
      rideProgressBar.style.width='0%';
      rideProgressSection.classList.add('hidden');
      endTripBtn.classList.add('hidden');
    }

    function refreshActiveCounter(){
      document.getElementById('activeRides').innerText = String(activeRideKeys.length);
    }

    // Haversine distance (km)
    function distanceKm(a, b){
      if(!a || !b) return null;
      const toRad = d=>d*Math.PI/180;
      const R=6371;
      const dLat=toRad(b.lat-a.lat);
      const dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
      const val = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(val));
    }

    function near(pt, landmark){ return distanceKm(pt, landmark) <= NEAR_RADIUS_KM; }

    function classifyRoute(pickup, dest){
      const isFromSAU = near(pickup, SAU1);
      const isToSAU = near(dest, SAU1);
      const isFromSat = near(pickup, SATBARI);
      const isToSat = near(dest, SATBARI);
      if (isFromSAU && isToSat) return 'SAU1_to_SATBARI';
      if (isFromSat && isToSAU) return 'SATBARI_to_SAU1';
      return null;
    }

    function updateRouteStatsUI(){
      const el = document.getElementById('routeStats');
      const d = new Date().toLocaleDateString();
      el.textContent = `Route stats today (${d}) ‚Äì SAU-1 ‚Üí Satbari: ${dailyRouteCounts.SAU1_to_SATBARI}, Satbari ‚Üí SAU-1: ${dailyRouteCounts.SATBARI_to_SAU1}`;
    }

    // Ride Requests from Firebase
    const requestsDiv = document.getElementById('requests');
    const ridesRef = ref(db, 'rides');

    onChildAdded(ridesRef, (snapshot) => {
      const ride = snapshot.val();
      const rideKey = snapshot.key;
      if (ride.status === 'pending') {
        // card
        const rideDiv = document.createElement('div');
        rideDiv.className = 'p-4 border rounded-lg bg-gray-50 shadow-sm flex justify-between items-center';
        rideDiv.innerHTML = `
          <div>
            <p><b>üìç Pickup:</b> ${fmtCoord(ride.pickup)}</p>
            <p><b>üéØ Destination:</b> ${fmtCoord(ride.destination)}</p>
            <p><b>üë§ Student:</b> ${ride.student || 'N/A'}</p>
            <p class="text-sm text-gray-600"><span>Driver ‚Üí Student:</span> <span id="dist-${rideKey}">‚Äì</span> ‚Ä¢ <span id="eta-${rideKey}">ETA ‚Äì</span></p>
            <p class="text-xs text-gray-500" id="confirmState-${rideKey}"></p>
          </div>
          <div class="flex gap-2">
            <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded acceptBtn">Accept</button>
          </div>
        `;

        const acceptBtn = rideDiv.querySelector('.acceptBtn');

        acceptBtn.addEventListener('click', () => {
          if (!driver) return showToast('Login first');
          const capacityLeft = Math.min(seatCount, MAX_SEATS) - activeRideKeys.length;
          if (capacityLeft <= 0) {
            return showToast('Seats full. End trip or increase seats (max 5).');
          }
          update(ref(db, 'rides/' + rideKey), { status: 'accepted', driver: driver.name });

          // track active
          activeRideKeys.push(rideKey);
          refreshActiveCounter();

          // Create Start + Confirm buttons
          const btnWrap = document.createElement('div');
          btnWrap.className = 'flex gap-2';
          const startBtn = document.createElement('button');
          startBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded';
          startBtn.innerText = 'Start Trip';
          startBtn.addEventListener('click', () => {
            update(ref(db, 'rides/' + rideKey), { status: 'in_progress' });
            if (!rideBatchInProgress) {
              rideBatchInProgress = true;
              startProgress();
            }
            showToast('Trip started üöó');
          });

          // Confirm student ride addition
          const confirmBtn = document.createElement('button');
          confirmBtn.className = 'bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded';
          confirmBtn.innerText = 'Confirm Pickup';
          confirmBtn.addEventListener('click', ()=>{
            update(ref(db, 'rides/' + rideKey), { driver_confirmed: true, confirmed_at: Date.now() });
            const cs = document.getElementById(`confirmState-${rideKey}`);
            cs.textContent = '‚úÖ Student pickup confirmed';
            showToast('Student pickup confirmed');
          });

          btnWrap.appendChild(startBtn);
          btnWrap.appendChild(confirmBtn);
          acceptBtn.replaceWith(btnWrap);

          // track ETA elements
          const distEl = rideDiv.querySelector(`#dist-${rideKey}`);
          const etaEl = rideDiv.querySelector(`#eta-${rideKey}`);
          etaSpans.set(rideKey, {distEl, etaEl, pickup: ride.pickup});

          // initial ETA compute if we already have location
          if (currentDriverPos) updateETATextForRide(rideKey, currentDriverPos, ride.pickup);

          showToast('Ride accepted ‚úÖ');
        });

        requestsDiv.appendChild(rideDiv);
        showToast('New ride request received!');
      }
    });

    function updateETATextForRide(rideKey, pos, pickup){
      const span = etaSpans.get(rideKey);
      if (!span) return;
      const a = { lat: pos.latitude, lng: pos.longitude };
      const dKm = distanceKm(a, pickup);
      if (dKm == null) return;
      const SPEED_KMPH = 25; // average city speed
      const etaMin = Math.max(1, Math.round((dKm / SPEED_KMPH) * 60));
      span.distEl.textContent = dKm.toFixed(2) + ' km';
      span.etaEl.textContent = `ETA ${etaMin} min`;
    }

    // End Trip flow (completes whole batch)
    endTripBtn.addEventListener('click', () => {
      if (!activeRideKeys.length) return;

      const now = Date.now();
      // complete all active rides
      activeRideKeys.forEach((rideKey) => {
        update(ref(db, 'rides/' + rideKey), { status: 'completed' });
        // push to local history and update route counters
        onValue(ref(db, 'rides/' + rideKey), (snap) => {
          const r = snap.val();
          if (!r) return;
          historyData.push({
            pickup: r.pickup,
            destination: r.destination,
            student: r.student,
            time: now
          });
          const route = classifyRoute(r.pickup, r.destination);
          const todayStr = new Date(now).toDateString();
          const isToday = new Date().toDateString() === todayStr;
          if (isToday && route){
            if (route === 'SAU1_to_SATBARI') dailyRouteCounts.SAU1_to_SATBARI++;
            if (route === 'SATBARI_to_SAU1') dailyRouteCounts.SATBARI_to_SAU1++;
            updateRouteStatsUI();
          }
          renderHistory(currentFilter);
        }, { onlyOnce: true });
      });

      totalTrips++;
      document.getElementById('totalTrips').innerText = String(totalTrips);
      activeRideKeys = [];
      refreshActiveCounter();
      rideBatchInProgress = false;
      resetProgress();
      renderBadges(totalTrips);
      showToast('Trip completed ‚úÖ');
    });

    // Badges
    function renderBadges(trips){
      const badges = document.getElementById('badges');
      badges.innerHTML = '';
      const tiers = [1, 5, 10, 25, 50];
      tiers.forEach(t => {
        const span = document.createElement('span');
        span.className = 'badge';
        span.textContent = trips >= t ? `üèÖ ${t}+ rides` : `‚≠ê ${t} rides`;
        badges.appendChild(span);
      });
    }

    // Trip History filter/render
    const historyList = document.getElementById('historyList');
    let currentFilter = 'today';

    function renderHistory(filter){
      currentFilter = filter;
      historyList.innerHTML = '';
      const now = new Date();
      const weekAgo = new Date();
      weekAgo.setDate(now.getDate() - 7);

      const filtered = historyData.filter(trip => {
        const d = new Date(trip.time);
        if (filter === 'today') return d.toDateString() === now.toDateString();
        if (filter === 'week') return d >= weekAgo;
        return true;
      });

      if (!filtered.length) {
        historyList.innerHTML = '<p class="text-gray-500">No trips for selected filter.</p>';
        return;
      }

      filtered.forEach(trip => {
        const d = new Date(trip.time);
        const div = document.createElement('div');
        div.className = 'p-3 border rounded bg-gray-50';
        div.innerHTML = `
          <p><b>üìç Pickup:</b> ${fmtCoord(trip.pickup)}</p>
          <p><b>üéØ Destination:</b> ${fmtCoord(trip.destination)}</p>
          <p><b>üë§ Student:</b> ${trip.student || 'N/A'}</p>
          <p><b>üïí Time:</b> ${d.toLocaleString()}</p>
        `;
        historyList.appendChild(div);
      });
    }

    function fmtCoord(p){
      if (!p) return 'N/A';
      if (typeof p.lat === 'number' && typeof p.lng === 'number') {
        return p.lat.toFixed(4) + ', ' + p.lng.toFixed(4);
      }
      try { return Number(p.lat).toFixed(4) + ', ' + Number(p.lng).toFixed(4); } catch(e){ return 'N/A'; }
    }

    document.querySelectorAll('.filterBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filterBtn').forEach(b => b.classList.remove('bg-green-600','text-white'));
        btn.classList.add('bg-green-600','text-white');
        renderHistory(btn.dataset.filter);
      });
    });

    // Maps init + GPS
    function initMaps(){
      map = L.map('map').setView([28.7041,77.1025], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      marker = L.marker([28.7041,77.1025]).addTo(map);

      miniMap = L.map('miniMap', { attributionControl:false, zoomControl:false }).setView([28.7041,77.1025],14);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
      miniMarker = L.marker([28.7041,77.1025]).addTo(miniMap);
    }
    initMaps();

    let currentDriverPos = null;
    function startLocationTracking(){
      if(navigator.geolocation){
        navigator.geolocation.watchPosition(pos=>{
          const {latitude, longitude} = pos.coords;
          currentDriverPos = { latitude, longitude };
          marker.setLatLng([latitude, longitude]);
          map.setView([latitude, longitude]);
          miniMarker.setLatLng([latitude, longitude]);
          miniMap.setView([latitude, longitude]);
          if (driverRef) update(driverRef, { lat: latitude, lng: longitude, timestamp: Date.now() });
          // update ETAs for all active rides
          activeRideKeys.forEach(rk=>{
            const info = etaSpans.get(rk);
            if (info) updateETATextForRide(rk, pos.coords, info.pickup);
          });
        }, err => console.error('GPS error:', err), { enableHighAccuracy: true, maximumAge: 0 });
      }
    }

    // Initial history + route stats render
    renderHistory('today');
    updateRouteStatsUI();

    lucide.createIcons();

    // Initial workTimes
    renderWorkTimes();
  </script>
</body>
</html>